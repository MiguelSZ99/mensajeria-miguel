<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Panel Miguel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:linear-gradient(135deg,#1c1b29,#4b2c5e);
      color:#fff;
      display:flex;
      min-height:100vh;
      justify-content:center;
      align-items:center;
      padding:16px;
    }
    .card{
      background:rgba(0,0,0,0.38);
      border-radius:18px;
      padding:26px;
      max-width:560px;
      width:100%;
      box-shadow:0 22px 50px rgba(0,0,0,0.45);
      backdrop-filter:blur(12px);
      border:1px solid rgba(255,255,255,0.08);
    }
    .top{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    h1{margin:0;font-size:2rem;}
    p.sub{margin:8px 0 0;font-size:0.95rem;opacity:0.85;}
    .badge{
      font-size:0.78rem;
      opacity:0.85;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.10);
      white-space:nowrap;
    }
    .section-title{
      margin-top:18px;
      font-size:0.92rem;
      font-weight:750;
      text-transform:uppercase;
      letter-spacing:0.09em;
      opacity:0.92;
    }

    /* === CHAT === */
    #chatWrap{
      margin-top:12px;
      height:380px;
      overflow-y:auto;
      padding:10px;
      border-radius:14px;
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.08);
    }
    .day-sep{text-align:center;font-size:0.78rem;opacity:0.85;margin:10px 0;}
    .row-msg{display:flex;margin:6px 0;}
    .row-msg.me{justify-content:flex-end;}
    .row-msg.other{justify-content:flex-start;}

    .bubble{
      max-width:80%;
      padding:10px 12px;
      border-radius:14px;
      line-height:1.35;
      font-size:0.95rem;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.08);
      color:#fff;
    }

    /* ===== TUS 5 COLORES (RELLENO COMPLETO) ===== */
    .me.theme-morado .bubble { background:#7c3aed; border-color:#7c3aed; color:#fff; }
    .me.theme-cielo  .bubble { background:#38bdf8; border-color:#38bdf8; color:#0b1220; }
    .me.theme-rosa   .bubble { background:#ff4da6; border-color:#ff4da6; color:#0b1220; }
    .me.theme-verde  .bubble { background:#22c55e; border-color:#22c55e; color:#0b1220; }
    .me.theme-negro  .bubble { background:#111827; border-color:#111827; color:#fff; }

    .meta{
      font-size:0.72rem;
      opacity:0.75;
      margin-top:6px;
      text-align:right;
      white-space:nowrap;
    }

    textarea{
      width:100%;
      border-radius:14px;
      padding:12px;
      border:none;
      resize:vertical;
      min-height:78px;
      font-family:inherit;
      font-size:0.96rem;
      outline:none;
      background:rgba(255,255,255,0.92);
      color:#1a1a1a;
    }
    .row{margin-top:10px;display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;}
    button{
      border:none;
      border-radius:999px;
      padding:11px 14px;
      font-size:0.95rem;
      cursor:pointer;
      background:#ff9bd2;
      color:#2a1430;
      font-weight:800;
    }

    /* selector color */
    .theme-picker{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      justify-content:space-between;
    }
    .chip{
      border-radius:999px;
      padding:8px 10px;
      font-size:0.82rem;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.14);
      cursor:pointer;
      user-select:none;
      opacity:0.9;
    }
    .chip.active{outline:2px solid rgba(255,255,255,0.55);}
    .small-text{font-size:0.82rem;opacity:0.78;margin-top:10px;}
  </style>
</head>

<body>
  <div class="card">
    <div class="top">
      <div>
        <h1>Panel Miguel ðŸ˜Ž</h1>
        <p class="sub">Historial tipo WhatsApp. Desliza hacia arriba para ver lo viejo.</p>
      </div>
      <div class="badge">Actualiza solo âœ…</div>
    </div>

    <div class="section-title">Chat (historial)</div>
    <div id="chatWrap"></div>

    <div class="section-title">Color de tus mensajes</div>
    <div class="theme-picker" id="themePicker">
      <div class="chip" data-theme="theme-morado">Morado</div>
      <div class="chip" data-theme="theme-cielo">Azul cielo</div>
      <div class="chip" data-theme="theme-rosa">Rosa</div>
      <div class="chip" data-theme="theme-verde">Verde</div>
      <div class="chip" data-theme="theme-negro">Negro</div>
    </div>

    <div class="section-title">Responder</div>
    <form method="post" action="{{ post_url }}">
      <textarea id="respInput" name="respuesta" placeholder="Escribe tu respuesta aquÃ­..."></textarea>
      <div class="row">
        <button type="submit">Enviar</button>
      </div>
    </form>

    <div class="small-text">
      *Tu color se guarda en este dispositivo.
    </div>
  </div>

<script>
  const chatWrap = document.getElementById("chatWrap");
  const themePicker = document.getElementById("themePicker");

  // ===== THEME (MIGUEL) =====
  let myTheme = localStorage.getItem("miguel_theme") || "theme-verde";

  function setActiveChip(){
    [...themePicker.querySelectorAll(".chip")].forEach(c=>{
      c.classList.toggle("active", c.dataset.theme === myTheme);
    });
  }
  themePicker.addEventListener("click",(e)=>{
    const chip = e.target.closest(".chip");
    if(!chip) return;
    myTheme = chip.dataset.theme;
    localStorage.setItem("miguel_theme", myTheme);
    setActiveChip();
    repaintThemes();
  });
  setActiveChip();

  // ===== STATE =====
  let page = 0;
  let loading = false;
  let reachedEnd = false;
  let lastId = 0;
  const knownIds = new Set();

  function fmtTime(iso){
    const d = new Date(iso);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }
  function fmtDateKey(iso){
    const d = new Date(iso);
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function repaintThemes(){
    [...chatWrap.querySelectorAll(".row-msg.me")].forEach(row=>{
      row.classList.remove("theme-morado","theme-cielo","theme-rosa","theme-verde","theme-negro");
      row.classList.add(myTheme);
    });
  }

  function appendMessages(msgs){
    const frag = document.createDocumentFragment();
    let lastSepKey = chatWrap.getAttribute("data-last-date") || "";

    msgs.forEach(m=>{
      if(!m || !m.id) return;
      if(knownIds.has(m.id)) return;
      knownIds.add(m.id);

      if(m.id > lastId) lastId = m.id;

      const dk = fmtDateKey(m.created_at);
      if(dk !== lastSepKey){
        const sep = document.createElement("div");
        sep.className = "day-sep";
        sep.textContent = dk;
        frag.appendChild(sep);
        lastSepKey = dk;
        chatWrap.setAttribute("data-last-date", dk);
      }

      const row = document.createElement("div");
      const isMe = (m.de === "miguel"); // en vista de miguel, "miguel" es yo
      row.className = "row-msg " + (isMe ? `me ${myTheme}` : "other");

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = m.texto;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = fmtTime(m.created_at);

      const wrap = document.createElement("div");
      wrap.appendChild(bubble);
      wrap.appendChild(meta);

      row.appendChild(wrap);
      frag.appendChild(row);
    });

    chatWrap.appendChild(frag);
  }

  function prependMessages(msgs){
    const beforeHeight = chatWrap.scrollHeight;
    const beforeTop = chatWrap.scrollTop;

    const frag = document.createDocumentFragment();
    let firstExistingSep = chatWrap.querySelector(".day-sep");
    let existingFirstKey = firstExistingSep ? firstExistingSep.textContent.trim() : null;

    let lastDate = null;

    msgs.forEach(m=>{
      if(!m || !m.id) return;
      if(knownIds.has(m.id)) return;
      knownIds.add(m.id);

      if(m.id > lastId) lastId = m.id;

      const dk = fmtDateKey(m.created_at);
      if(dk !== lastDate){
        if(!(existingFirstKey && dk === existingFirstKey)){
          const sep = document.createElement("div");
          sep.className = "day-sep";
          sep.textContent = dk;
          frag.appendChild(sep);
        }
        lastDate = dk;
      }

      const row = document.createElement("div");
      const isMe = (m.de === "miguel");
      row.className = "row-msg " + (isMe ? `me ${myTheme}` : "other");

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = m.texto;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = fmtTime(m.created_at);

      const wrap = document.createElement("div");
      wrap.appendChild(bubble);
      wrap.appendChild(meta);

      row.appendChild(wrap);
      frag.appendChild(row);
    });

    if(frag.childNodes.length){
      chatWrap.prepend(frag);
      const afterHeight = chatWrap.scrollHeight;
      chatWrap.scrollTop = (afterHeight - beforeHeight) + beforeTop;
    }
  }

  async function loadPage(p){
    if(loading || reachedEnd) return;
    loading = true;
    try{
      const res = await fetch(`{{ chat_url }}?page=${p}`);
      const data = await res.json();
      const msgs = data.mensajes || [];
      if(msgs.length === 0){
        reachedEnd = true;
        loading = false;
        return;
      }
      if(p === 0){
        appendMessages(msgs);
        chatWrap.scrollTop = chatWrap.scrollHeight;
      }else{
        prependMessages(msgs);
      }
    }catch(e){
      console.log("Error:", e);
    }
    loading = false;
  }

  async function pollNew(){
    const atBottom = (chatWrap.scrollHeight - chatWrap.scrollTop - chatWrap.clientHeight) < 20;
    if(!atBottom) return;

    try{
      const res = await fetch(`{{ chat_url }}?after_id=${lastId}`);
      const data = await res.json();
      const msgs = data.mensajes || [];
      if(msgs.length){
        appendMessages(msgs);
        chatWrap.scrollTop = chatWrap.scrollHeight;
      }
    }catch(e){
      console.log("poll error:", e);
    }
  }

  // inicial
  loadPage(0);

  // scroll arriba = cargar viejos
  chatWrap.addEventListener("scroll", async ()=>{
    if(chatWrap.scrollTop <= 5 && !loading && !reachedEnd){
      page += 1;
      await loadPage(page);
    }
  });

  setInterval(pollNew, 6000);
</script>

</body>
</html>

